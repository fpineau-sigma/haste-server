var haste_document=function(){this.locked=!1};haste_document.prototype.htmlEscape=function(t){return t.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},haste_document.prototype.save=function(t,e){if(this.locked)return!1;var o=this;$.ajax("/documents",{type:"post",data:JSON.stringify(t),dataType:"json",contentType:"application/json; charset=utf-8",success:function(s){o.locked=!0,o.key=s.key;var n=t.data,a=hljs.highlightAuto(n);e(null,{value:a.value,key:s.key,language:a.language,lineCount:n.split("\n").length})},error:function(t){try{e($.parseJSON(t.responseText))}catch(t){e({message:"Something went wrong!"})}}})},haste_document.prototype.load=function(t,e,o){var s=this;$.ajax("/documents/"+t,{type:"get",dataType:"json",statusCode:{200:function(n){s.locked=!0,s.key=t,s.data=n.data,s.tags=n.tags;try{var a;a="txt"===o?{value:s.htmlEscape(n.data)}:o?hljs.highlight(o,n.data):hljs.highlightAuto(n.data),$("#tags").val(n.tags).trigger("change")}catch(t){a=hljs.highlightAuto(n.data)}e({value:a.value,key:t,language:a.language||o,lineCount:n.data.split("\n").length})},500:function(t){try{e($.parseJSON(t.responseText))}catch(t){e({message:"Something went wrong!"})}}}})},haste_document.prototype.getAll=function(t){$.ajax("/documents/all",{type:"get",dataType:"json",success:function(e){t(e)},error:function(e){t(e.message)}})},haste_document.prototype.getAllTags=function(t){$.ajax("/documents/allTags",{type:"get",dataType:"json",success:function(e){t(e)},error:function(e){try{t($.parseJSON(e.responseText))}catch(e){t({message:"Something went wrong!"})}}})},haste_document.prototype.search=function(t,e){$.ajax("/documents/search",{type:"post",data:JSON.stringify(t),dataType:"json",contentType:"application/json; charset=utf-8",success:function(t){e(t)},error:function(t){try{e($.parseJSON(t.responseText))}catch(t){e({message:"Something went wrong!"})}}})},haste_document.prototype.getAllCloudTags=function(t){$.ajax("/documents/allCloudTags",{type:"get",dataType:"json",success:function(e){t(e)},error:function(e){try{t($.parseJSON(e.responseText))}catch(e){t({message:"Something went wrong!"})}}})},haste_document.prototype.get=function(t,e,o){var s=this;$.ajax("/documents/"+t,{type:"get",dataType:"json",statusCode:{200:function(n){s.locked=!0,s.key=t,s.data=n.data,s.tags=n.tags;try{var a;a="txt"===o?{value:s.htmlEscape(n.data)}:o?hljs.highlight(o,n.data):hljs.highlightAuto(n.data),n.tags.forEach(function(t){$("#tags").val(t).trigger("change")})}catch(t){a=hljs.highlightAuto(n.data)}e({value:a.value,key:t,language:a.language||o,lineCount:n.data.split("\n").length})},500:function(t){console.log(t);var e=$('<li class="error">'+t.message+"</li>");$("#messages").prepend(e),setTimeout(function(){e.slideUp("fast",function(){$(this).remove()})},3e3)}}})};var haste=function(t,e){this.appName=t,this.$textarea=$("textarea"),this.$box=$("#box"),this.$code=$("#box code"),this.$title=$("#title"),this.$linenos=$("#linenos"),this.$tags=$("#tags"),this.$cloudTags=$("#block_content"),this.options=e,this.configureShortcuts(),this.configureButtons(),this.configureListFiles(),this.configureChosen(),this.configureCloudTag(),e.twitter||$("#box2 .twitter").hide()};haste.prototype.titleEscape=function(t){return t.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/ /g,"_")},haste.prototype.configureListFiles=function(){$("#box4 .label").text("10 derniers ajouts :");var t=this;t.docs=new haste_document,t.docs.getAll(function(t){$.each(t.data,function(t,e){$("#files").append($('<li><a href="/'+e+'">'+e+"</a></li>"))})})},haste.prototype.configureCloudTag=function(){$("#box7 .label").text("Mots clés les plus utilisés:");var t=this;t.docs.getAllCloudTags(function(e){var o=e.data;Object.keys(o).sort(function(t,e){return o[e].weight-o[t].weight}),t.$cloudTags.jQCloud(o.slice(0,10),{fontSize:{from:.2,to:.04}})})},haste.prototype.configureChosen=function(){var t=this;t.docs.getAllTags(function(e){$.each(e.data,function(e,o){t.$tags.append(new Option(o,o,!1,!1))}),$(".chosen-select").select2({placeholder:"Choisissez ou ajoutez un tag",width:"200px",tags:!0,tokenSeparators:[","," "]})})},haste.prototype.setTitle=function(t){var e=this.appName;document.title=e},haste.prototype.showMessage=function(t,e){var o=$('<li class="'+(e||"info")+'">'+t+"</li>");$("#messages").prepend(o),setTimeout(function(){o.slideUp("fast",function(){$(this).remove()})},3e3)},haste.prototype.lightKey=function(){this.configureKey(["new","save","search"])},haste.prototype.fullKey=function(){this.configureKey(["new","duplicate","twitter","raw"])},haste.prototype.configureKey=function(t){var e,o=0;$("#box2 .function").each(function(){for(e=$(this),o=0;o<t.length;o++)if(e.hasClass(t[o]))return e.addClass("enabled"),!0;e.removeClass("enabled")})},haste.prototype.newDocument=function(t){this.$box.hide(),this.doc=new haste_document,t||window.history.pushState(null,this.appName,"/"),this.setTitle(),this.lightKey(),this.$textarea.val("").show("fast",function(){this.focus()}),this.$tags.val(null).trigger("change"),this.$title.val(null),this.removeLineNumbers()},haste.extensionMap={rb:"ruby",py:"python",pl:"perl",php:"php",scala:"scala",go:"go",xml:"xml",html:"xml",htm:"xml",css:"css",js:"javascript",vbs:"vbscript",lua:"lua",pas:"delphi",java:"java",cpp:"cpp",cc:"cpp",m:"objectivec",vala:"vala",sql:"sql",sm:"smalltalk",lisp:"lisp",ini:"ini",diff:"diff",bash:"bash",sh:"bash",tex:"tex",erl:"erlang",hs:"haskell",md:"markdown",txt:"",coffee:"coffee",json:"javascript",swift:"swift"},haste.prototype.lookupExtensionByType=function(t){for(var e in haste.extensionMap)if(haste.extensionMap[e]===t)return e;return t},haste.prototype.lookupTypeByExtension=function(t){return haste.extensionMap[t]||t},haste.prototype.addLineNumbers=function(t){for(var e="",o=0;o<t;o++)e+=(o+1).toString()+"<br/>";$("#linenos").html(e)},haste.prototype.removeLineNumbers=function(){$("#linenos").html("&gt;")},haste.prototype.loadDocument=function(t){var e=t.split(".",2),o=this;o.doc=new haste_document,o.doc.load(e[0],function(t){t?(o.$code.html(t.value),o.setTitle(t.key),o.$title.val(t.key),o.fullKey(),o.$textarea.val("").hide(),o.$box.show().focus(),o.addLineNumbers(t.lineCount)):(o.showMessage(t,"error"),o.newDocument())},this.lookupTypeByExtension(e[1]))},haste.prototype.duplicateDocument=function(){if(this.doc.locked){var t=this.doc.data;this.newDocument(),this.$textarea.val(t)}},haste.prototype.search=function(){var t=this,e={keys:t.$title.val().trim().split(" "),tags:t.$tags.val()};""===e.keys[0]&&null===e.tags?t.showMessage("Renseigner un &eacutel&eacutement dans le titre ou les tags","error"):this.doc.search(e,function(e){var o="";e.key&&(o+="R&eacutesultat de la recherche sur le titre :\n\n",e.key.forEach(function(t){o+='<a href="/'+t+'"><strong>'+t+"</strong></a>\n"})),e.tags&&(o+="\nR&eacutesultat de la recherche sur les tags :\n\n",e.tags.forEach(function(t){o+='<a href="/'+t+'"><strong>'+t+"</strong></a>\n"})),t.$code.html(o),t.$textarea.val("").hide(),t.$box.show().focus()})},haste.prototype.lockDocument=function(){var t=this,e={data:t.$textarea.val(),tags:t.$tags.val(),title:t.titleEscape(t.$title.val().trim())};console.log(t.$title.val().trim()),""===this.$title.val()?t.showMessage("Merci de renseigner un titre","error"):this.doc.save(e,function(e,o){if(e)t.showMessage(e.message,"error");else if(o){t.$code.html(o.value),t.setTitle(o.key);var s="/"+o.key;window.history.pushState(null,t.appName+"-"+o.key,s),t.fullKey(),t.$textarea.val("").hide(),t.$box.show().focus(),t.addLineNumbers(o.lineCount)}})},haste.prototype.configureButtons=function(){var t=this;this.buttons=[{$where:$("#box2 .save"),label:"Save",shortcutDescription:"control + s",shortcut:function(t){return t.ctrlKey&&83===t.keyCode},action:function(){""!==t.$textarea.val().replace(/^\s+|\s+$/g,"")&&t.lockDocument()}},{$where:$("#box2 .new"),label:"New",shortcut:function(t){return t.ctrlKey&&78===t.keyCode},shortcutDescription:"control + n",action:function(){t.newDocument(!t.doc.key)}},{$where:$("#box2 .duplicate"),label:"Duplicate & Edit",shortcut:function(e){return t.doc.locked&&e.ctrlKey&&68===e.keyCode},shortcutDescription:"control + d",action:function(){t.duplicateDocument()}},{$where:$("#box2 .raw"),label:"Just Text",shortcut:function(t){return t.ctrlKey&&t.shiftKey&&82===t.keyCode},shortcutDescription:"control + shift + r",action:function(){window.location.href="/raw/"+t.doc.key}},{$where:$("#box6 .twitter"),label:"Twitter",shortcut:function(e){return t.options.twitter&&t.doc.locked&&e.shiftKey&&e.ctrlKey&&84==e.keyCode},shortcutDescription:"control + shift + t",action:function(){window.open("https://twitter.com/share?url="+encodeURI(window.location.href))}},{$where:$("#box2 .search"),label:"Search",shortcut:function(t){return t.ctrlKey&&83===t.keyCode},shortcutDescription:"control + s",action:function(){t.search()}}];for(var e=0;e<this.buttons.length;e++)this.configureButton(this.buttons[e])},haste.prototype.configureButton=function(t){t.$where.click(function(e){e.preventDefault(),!t.clickDisabled&&$(this).hasClass("enabled")&&t.action()}),t.$where.mouseenter(function(){$("#box3 .label").text(t.label),$("#box3 .shortcut").text(t.shortcutDescription||""),$("#box3").show(),$(this).append($("#pointer").remove().show())}),t.$where.mouseleave(function(){$("#box3").hide(),$("#pointer").hide()})},haste.prototype.configureShortcuts=function(){var t=this;$(document.body).keydown(function(e){for(var o,s=0;s<t.buttons.length;s++)if((o=t.buttons[s]).shortcut&&o.shortcut(e))return e.preventDefault(),void o.action()})},$(function(){$("textarea").keydown(function(t){if(9===t.keyCode){t.preventDefault();if(document.selection)this.focus(),document.selection.createRange().text="  ",this.focus();else if(this.selectionStart||"0"==this.selectionStart){var e=this.selectionStart,o=this.selectionEnd,s=this.scrollTop;this.value=this.value.substring(0,e)+"  "+this.value.substring(o,this.value.length),this.focus(),this.selectionStart=e+"  ".length,this.selectionEnd=e+"  ".length,this.scrollTop=s}else this.value+="  ",this.focus()}})});